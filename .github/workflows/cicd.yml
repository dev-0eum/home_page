name: Django CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ====================================================
  # JOB 1: CI (지속적 통합) - 테스트 및 빌드 검증
  # ====================================================
  ci-test:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.12, 3.13]

    steps:
    - uses: actions/checkout@v4 # github 저장소 코드 내려받기
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Tests
      # CI 환경에서는 가짜 키를 써도 상관없습니다.
      env:
        SECRET_KEY: django-insecure-test-key-for-ci
        DEBUG: True
      run: |
        python manage.py test

  # 2. 도커 이미지 빌드 테스트 (배포 전 이미지가 잘 구워지는지 확인)
  build-check:
    runs-on: ubuntu-latest
    needs: ci-test  # 위의 test가 통과해야만 실행됨 (선택사항)
    
    steps:
    - uses: actions/checkout@v3 # 소스코드 가져오기

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image
      # 실제로 푸시하진 않고 빌드만 해봅니다.
      uses: docker/build-push-action@v4 # v5는 빌드&푸시
      with:
        context: .
        push: false
        tags: django-test-image:latest
        # 빌드 시에도 SECRET_KEY가 필요하다면 아래처럼 넣어줍니다.
        build-args: |
          SECRET_KEY=dummy-key-for-build

  # ====================================================
  # JOB 3: CD (지속적 배포) - 서버에 반영
  # ====================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-check

    # PR일 때는 실행하지 않고, 'push' 이벤트이면서 'main' 브랜치일 때만 배포
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # 1. SSH 접속 및 명령어 실행 액션
      # - uses: 사용할 액션의 이름 (제작자/액션명)
      # - @master: 특정 버전 숫자가 아니라, 개발자의 최신 코드(Master 브랜치)를 쓴다는 뜻
      - name: Deploy to EC2 Server
        uses: appleboy/ssh-action@master  
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # 1. 프로젝트 폴더로 이동 (경로 확인 필수!)
            cd /home/home_page

            #test(Completed)
            #touch test_$(date +\%y\%m\%d_\%H\%M\%S)
            
            # 2. 최신 코드 받기
            #git pull origin main

            # 3. 컨테이너 재시작 (서버의 .env 파일 사용)
            #docker-compose down
            #docker-compose up -d --build

            # 4. 불필요한 이미지 삭제
            #docker image prune -f
            
