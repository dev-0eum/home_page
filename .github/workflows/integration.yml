name: Django CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.11, 3.12, 3.13]

    steps:
    - uses: actions/checkout@v4 # github 저장소 코드 내려받기
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Tests
      # CI 환경에서는 가짜 키를 써도 상관없습니다.
      env:
        SECRET_KEY: django-insecure-test-key-for-ci
        DEBUG: True
      run: |
        python manage.py test

  # 2. 도커 이미지 빌드 테스트 (배포 전 이미지가 잘 구워지는지 확인)
  build-check:
    runs-on: ubuntu-latest
    needs: test  # 위의 test가 통과해야만 실행됨 (선택사항)
    
    steps:
    - uses: actions/checkout@v3 # 소스코드 가져오기

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image
      # 실제로 푸시하진 않고 빌드만 해봅니다.
      uses: docker/build-push-action@v4 # v5는 빌드&푸시
      with:
        context: .
        push: false
        tags: django-test-image:latest
        # 빌드 시에도 SECRET_KEY가 필요하다면 아래처럼 넣어줍니다.
        build-args: |
          SECRET_KEY=dummy-key-for-build
